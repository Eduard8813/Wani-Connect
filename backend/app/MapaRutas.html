<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reservas de Terminales - Wanni Connect</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    

    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
        
        .map-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        #map {
            height: 600px;
            width: 100%;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: #3498db;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            background: #ffebee;
            color: #c62828;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .terminal-details {
            display: flex;
            margin-bottom: 20px;
        }
        
        .terminal-image {
            flex: 1;
            padding-right: 20px;
        }
        
        .terminal-image img {
            width: 100%;
            border-radius: 8px;
        }
        
        .terminal-info {
            flex: 2;
        }
        
        .terminal-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .terminal-location {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .terminal-codigo {
            background-color: #e8f4f8;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 15px;
            font-family: monospace;
            font-weight: bold;
            color: #2980b9;
        }
        
        .lugares-container {
            margin-top: 20px;
        }
        
        .lugares-grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 30px;
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .lugares-grid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
            pointer-events: none;
        }
        
        .bus-layout {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            padding: 25px;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 30px;
            box-shadow: 
                0 15px 35px rgba(0,0,0,0.1),
                inset 0 2px 4px rgba(255,255,255,0.9),
                inset 0 -2px 4px rgba(0,0,0,0.05);
            border: 4px solid #495057;
            position: relative;
            z-index: 1;
        }
        
        .bus-layout::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            background: linear-gradient(145deg, #28a745, #20c997);
            padding: 8px 15px;
            border-radius: 20px;
            border: 3px solid #ffffff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            animation: busFloat 3s ease-in-out infinite;
        }
        
        @keyframes busFloat {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-3px); }
        }
        
        .bus-layout::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            right: 20px;
            height: 8px;
            background: linear-gradient(90deg, #6c757d, #495057, #6c757d);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .bus-row {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }
        
        .bus-aisle-horizontal {
            color: #495057;
            font-weight: bold;
            background: linear-gradient(90deg, #e9ecef, #dee2e6);
            border-radius: 10px;
            font-size: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 2px dashed #adb5bd;
            padding: 5px 10px;
            min-width: 60px;
            text-align: center;
        }
        
        .lugar-item {
            width: 50px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 3px solid;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            font-weight: bold;
            font-size: 13px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .lugar-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .lugar-item:hover::before {
            transform: translateX(100%);
        }
        
        .lugar-item:hover {
            transform: scale(1.05);
        }
        
        .lugar-item.disponible {
            background: linear-gradient(145deg, #d4edda, #c3e6cb);
            border-color: #28a745;
            color: #155724;
            box-shadow: 
                0 4px 8px rgba(40, 167, 69, 0.2),
                inset 0 1px 2px rgba(255,255,255,0.8);
        }
        
        .lugar-item.disponible:hover {
            background: linear-gradient(145deg, #c3e6cb, #b8dcc4);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 8px 16px rgba(40, 167, 69, 0.3),
                inset 0 1px 2px rgba(255,255,255,0.9);
        }
        
        .lugar-item.reservado {
            background: linear-gradient(145deg, #f8d7da, #f5c6cb);
            border-color: #dc3545;
            color: #721c24;
            cursor: not-allowed;
            box-shadow: 
                0 4px 8px rgba(220, 53, 69, 0.2),
                inset 0 1px 2px rgba(0,0,0,0.1);
            opacity: 0.7;
        }
        
        .lugar-item.reservado:hover {
            background: linear-gradient(145deg, #f5c6cb, #f1b0b7);
        }
        
        .lugar-item.selected {
            background: linear-gradient(145deg, #007bff, #0056b3);
            border-color: #0056b3;
            color: #ffffff;
            box-shadow: 
                0 8px 20px rgba(0, 123, 255, 0.4),
                inset 0 1px 2px rgba(255,255,255,0.3);
            transform: scale(1.1);
            animation: selectedPulse 2s ease-in-out infinite;
        }
        
        @keyframes selectedPulse {
            0%, 100% { box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4), inset 0 1px 2px rgba(255,255,255,0.3); }
            50% { box-shadow: 0 12px 30px rgba(0, 123, 255, 0.6), inset 0 1px 2px rgba(255,255,255,0.5); }
        }
        
        .lugar-timer {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 0.7rem;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .confirmacion-modal .modal-content {
            text-align: center;
        }
        
        .codigo-reserva {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
        }
        
        .terminal-extra-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 8px;
        }
        
        .info-label {
            font-weight: bold;
            width: 120px;
            color: #7f8c8d;
        }
        
        .info-value {
            color: #2c3e50;
        }
        
        .bus-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .bus-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .bus-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .bus-info-item {
            flex: 1;
            min-width: 150px;
        }
        
        .bus-info-label {
            font-weight: bold;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .bus-info-value {
            color: #2c3e50;
        }
        
        .bus-lugares {
            margin-top: 15px;
        }
        
        .bus-lugares-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .bus-loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .retry-button {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .retry-button:hover {
            background-color: #2980b9;
        }
        
        .endpoint-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .endpoint-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .endpoint-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            background: rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }
        
        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .legend-disponible {
            background: linear-gradient(145deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
        }
        
        .legend-reservado {
            background: linear-gradient(145deg, #f8d7da, #f5c6cb);
            border: 2px solid #dc3545;
        }
        
        .legend-seleccionado {
            background: linear-gradient(145deg, #007bff, #0056b3);
            border: 2px solid #0056b3;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h2 {
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.info {
            background-color: #3498db;
        }
        
        .lugares-info {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .lugares-contador {
            background: linear-gradient(145deg, #e8f4f8, #d1ecf1);
            border-radius: 15px;
            padding: 15px 25px;
            text-align: center;
            border: 2px solid #bee5eb;
            box-shadow: 
                0 8px 16px rgba(0,0,0,0.1),
                inset 0 1px 2px rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
        }
        
        .lugares-contador::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        .loading-text {
            font-size: 18px;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-dots {
            display: inline-block;
            animation: loadingDots 1.5s infinite;
        }
        
        @keyframes loadingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .validation-method-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .method-btn {
            padding: 10px 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .method-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .method-btn:hover {
            transform: translateY(-2px);
        }
        
        .validation-section {
            margin-top: 20px;
        }
        
        .qr-preview {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .lugares-contador-valor {
            font-size: 1.8rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .lugares-contenedor {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        
        .resumen-seleccion {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .resumen-seleccion h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .resumen-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .resumen-label {
            font-weight: bold;
            color: #555;
        }
        
        .resumen-valor {
            color: #333;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            #map {
                height: 400px;
            }
            
            .terminal-details {
                flex-direction: column;
            }
            
            .terminal-image {
                padding-right: 0;
                padding-bottom: 15px;
            }
            
            .bus-layout {
                max-width: 320px;
                padding: 20px;
            }
            
            .bus-row {
                gap: 10px;
            }
            
            .lugar-item {
                width: 42px;
                height: 35px;
                font-size: 12px;
            }
            
            .legend {
                flex-direction: column;
                gap: 15px;
            }
            
            .legend-item {
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
            }
            
            .info-row {
                flex-direction: column;
            }
            
            .info-label {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .bus-info {
                flex-direction: column;
            }
            
            .user-info {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div id="appContainer" style="display: none;">
        <div class="user-info">
            <img src="https://picsum.photos/seed/user123/30/30.jpg" alt="Usuario">
            <span id="userInfo">Usuario</span>
            <button class="btn btn-danger btn-sm" onclick="logout()">Salir</button>
        </div>
        
        <div class="container">
            <header>
                <h1>Sistema de Reservas de Terminales</h1>
                <p class="subtitle">Wanni Connect - Reserva tu lugar en las terminales de buses de Nicaragua</p>
            </header>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div id="loadingMessage" class="loading">Cargando datos...</div>
            <div id="errorMessage" class="error" style="display: none;"></div>
            <div id="endpointStatus"></div>
        </div>
    </div>

    <!-- Contenedor de login -->
    <div id="loginContainer" class="login-container">
        <div class="login-header">
            <div class="login-logo">
                <i class="fas fa-bus"></i>
            </div>
            <h2>Wanni Connect</h2>
            <p>Inicia sesi贸n para acceder al sistema</p>
        </div>
        
        <div class="form-group">
            <label>Tipo de cuenta:</label>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button type="button" class="btn btn-outline-primary" id="userTypeBtn" onclick="selectLoginType('user')" style="flex: 1;">Usuario</button>
                <button type="button" class="btn btn-outline-warning" id="companyTypeBtn" onclick="selectLoginType('company')" style="flex: 1;">Empresa</button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="username">Usuario:</label>
            <input type="text" id="username" class="form-control" placeholder="Nombre de usuario">
        </div>
        
        <div class="form-group">
            <label for="password">Contrase帽a:</label>
            <input type="password" id="password" class="form-control" placeholder="Contrase帽a">
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">Iniciar Sesi贸n</button>
        </div>
        
        <div class="text-center" style="margin-top: 15px;">
            <small><a href="#" onclick="mostrarRegistro()" style="color: #3498db;">驴No tienes cuenta? Reg铆strate aqu铆</a></small>
        </div>
        
        <div id="loginError" class="error" style="display: none;"></div>
        
        <div class="login-footer">
            <p>&copy; 2023 Wanni Connect. Todos los derechos reservados.</p>
        </div>
    </div>

    <!-- Modal para detalles de la terminal -->
    <div id="terminalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTerminalModal()">&times;</span>
            <div class="terminal-details">
                <div class="terminal-image">
                    <img id="terminalImage" src="" alt="Terminal">
                </div>
                <div class="terminal-info">
                    <h2 class="terminal-name" id="terminalName"></h2>
                    <p class="terminal-location" id="terminalLocation"></p>
                    <div class="terminal-codigo" id="terminalCodigo"></div>
                    
                    <div class="terminal-extra-info">
                        <div class="info-row">
                            <span class="info-label">Latitud:</span>
                            <span class="info-value" id="terminalLatitud"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Longitud:</span>
                            <span class="info-value" id="terminalLongitud"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Direcci贸n:</span>
                            <span class="info-value" id="terminalDireccion">No especificada</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Secci贸n de buses disponibles -->
            <div class="bus-details" id="busDetails" style="display: none;">
                <h3 class="bus-title">Buses Disponibles</h3>
                <div id="busesList"></div>
            </div>
            

            
            <div class="action-buttons">
                <button class="btn btn-info" onclick="mostrarValidarCodigo()">Validar Reserva</button>
                <button class="btn btn-warning" onclick="mostrarConductorModal()">Liberar Bus</button>
                <button class="btn btn-secondary" onclick="closeTerminalModal()">Cerrar</button>
            </div>
            
            <div class="lugares-container" id="lugaresContainer" style="display: none;">
                <h3>Selecciona un lugar:</h3>
                
                <!-- Resumen de selecci贸n -->
                <div class="resumen-seleccion" id="resumenSeleccion" style="display: none;">
                    <h4>Resumen de tu selecci贸n:</h4>
                    <div class="resumen-item">
                        <span class="resumen-label">Bus:</span>
                        <span class="resumen-valor" id="resumenBus">-</span>
                    </div>
                    <div class="resumen-item">
                        <span class="resumen-label">Destino:</span>
                        <span class="resumen-valor" id="resumenDestino">-</span>
                    </div>
                    <div class="resumen-item">
                        <span class="resumen-label">Hora de salida:</span>
                        <span class="resumen-valor" id="resumenHora">-</span>
                    </div>
                    <div class="resumen-item">
                        <span class="resumen-label">Lugar seleccionado:</span>
                        <span class="resumen-valor" id="resumenLugar">-</span>
                    </div>
                </div>
                
                <!-- Contador de lugares disponibles -->
                <div class="lugares-info">
                    <div class="lugares-contador">
                        <div class="lugares-contador-valor" id="lugaresDisponiblesValor">0</div>
                        <div>Lugares disponibles</div>
                    </div>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color legend-disponible"></div>
                        <span>Disponible</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-reservado"></div>
                        <span>Reservado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-seleccionado"></div>
                        <span>Seleccionado</span>
                    </div>
                </div>
                
                <div class="lugares-grid" id="lugaresGrid"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="closeLugares()">Cancelar</button>
                    <button class="btn btn-success" id="confirmarReservaBtn" onclick="confirmarReserva()" disabled>Confirmar Reserva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci贸n -->
    <div id="confirmacionModal" class="modal confirmacion-modal">
        <div class="modal-content">
            <span class="close" onclick="closeConfirmacionModal()">&times;</span>
            <h2>Reserva Confirmada</h2>
            <p>Tu reserva ha sido realizada con 茅xito.</p>
            <div class="codigo-reserva" id="codigoReserva"></div>
            <p>Hemos enviado un correo electr贸nico con los detalles de tu reserva.</p>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="closeConfirmacionModal()">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Modal para email -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmailModal()">&times;</span>
            <h2>Confirmar Email</h2>
            <p>Ingresa tu email para recibir el c贸digo de reserva:</p>
            
            <div class="form-group">
                <label for="emailInput">Email:</label>
                <input type="email" id="emailInput" class="form-control" placeholder="tu@email.com">
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="closeEmailModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="procesarReservaConEmail()">Confirmar Reserva</button>
            </div>
        </div>
    </div>

    <!-- Modal para conductor -->
    <div id="conductorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeConductorModal()">&times;</span>
            <h2>Panel del Conductor</h2>
            <p>Selecciona el bus que ha salido de la terminal para liberar todos sus asientos:</p>
            
            <div id="conductorBusesList" class="mb-3">
                <div class="loading">Cargando buses...</div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="closeConductorModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para registro de usuario -->
    <div id="registroUsuarioModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRegistroUsuarioModal()">&times;</span>
            <h2>Registro de Usuario</h2>
            <p>Crea tu cuenta de usuario para acceder al sistema de reservas.</p>
            
            <div class="form-group">
                <label for="usuarioUsername">Usuario:</label>
                <input type="text" id="usuarioUsername" class="form-control" placeholder="Nombre de usuario">
                <button type="button" class="btn btn-sm btn-info" onclick="generarUsuarioRegular()" style="margin-top: 5px;">Generar Usuario</button>
            </div>
            
            <div class="form-group">
                <label for="usuarioPassword">Contrase帽a:</label>
                <input type="password" id="usuarioPassword" class="form-control" placeholder="Contrase帽a">
            </div>
            
            <div class="form-group">
                <label for="usuarioEmail">Email:</label>
                <input type="email" id="usuarioEmail" class="form-control" placeholder="tu@email.com">
            </div>
            
            <div class="form-group">
                <label for="usuarioNombre">Nombre:</label>
                <input type="text" id="usuarioNombre" class="form-control" placeholder="Tu nombre">
            </div>
            
            <div class="form-group">
                <label for="usuarioApellido">Apellido:</label>
                <input type="text" id="usuarioApellido" class="form-control" placeholder="Tu apellido">
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="closeRegistroUsuarioModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="registrarUsuario()">Registrar Usuario</button>
            </div>
            
            <div id="registroUsuarioError" class="error" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal para registro de empresa -->
    <div id="registroEmpresaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRegistroEmpresaModal()">&times;</span>
            <h2>Registro de Cuenta Empresarial</h2>
            <p>Para acceder a las funciones de conductor, necesitas una cuenta empresarial.</p>
            
            <div class="form-group">
                <label for="empresaUsername">Usuario:</label>
                <input type="text" id="empresaUsername" class="form-control" placeholder="Nombre de usuario (debe ser 煤nico)">
                <button type="button" class="btn btn-sm btn-info" onclick="generarUsuarioEmpresa()" style="margin-top: 5px;">Generar Usuario</button>
            </div>
            
            <div class="form-group">
                <label for="empresaPassword">Contrase帽a:</label>
                <input type="password" id="empresaPassword" class="form-control" placeholder="Contrase帽a">
            </div>
            
            <div class="form-group">
                <label for="empresaEmail">Email:</label>
                <input type="email" id="empresaEmail" class="form-control" placeholder="email@empresa.com (debe ser 煤nico)">
            </div>
            
            <div class="form-group">
                <label for="empresaNombre">Nombre de la Empresa:</label>
                <input type="text" id="empresaNombre" class="form-control" placeholder="Nombre de la empresa">
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="closeRegistroEmpresaModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="registrarEmpresa()">Registrar Empresa</button>
            </div>
            
            <div id="registroEmpresaError" class="error" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal para validar c贸digo -->
    <div id="validarCodigoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeValidarCodigoModal()">&times;</span>
            <h2>Validar Reserva</h2>
            
            <!-- Selector de m茅todo de validaci贸n -->
            <div class="validation-method-selector">
                <button class="btn btn-primary method-btn active" onclick="selectValidationMethod('codigo')" id="btnCodigo">
                    <i class="fas fa-keyboard"></i> C贸digo
                </button>
                <button class="btn btn-secondary method-btn" onclick="selectValidationMethod('qr')" id="btnQR">
                    <i class="fas fa-qrcode"></i> QR
                </button>
            </div>
            
            <!-- Validaci贸n por c贸digo -->
            <div id="validacionCodigo" class="validation-section">
                <div class="form-group">
                    <label for="codigoValidar">C贸digo de Reserva:</label>
                    <input type="text" id="codigoValidar" class="form-control" placeholder="Ingresa el c贸digo de reserva">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="validarCodigo()">Validar C贸digo</button>
                </div>
            </div>
            
            <!-- Validaci贸n por QR -->
            <div id="validacionQR" class="validation-section" style="display: none;">
                <div class="form-group">
                    <label for="qrFile">Seleccionar imagen QR:</label>
                    <input type="file" id="qrFile" class="form-control" accept="image/*" onchange="previewQR(this)">
                </div>
                <div id="qrPreview" class="qr-preview" style="display: none;">
                    <img id="qrImage" src="" alt="QR Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="validarQR()" id="validarQRBtn" disabled>Validar QR</button>
                </div>
            </div>
            
            <div id="resultadoValidacion" class="" style="display: none; margin: 15px 0; padding: 10px; border-radius: 5px;"></div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="closeValidarCodigoModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Notificaci贸n -->
    <div id="notification" class="notification"></div>

    <!-- Pantalla de carga global -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Cargando...</div>
            <div class="loading-subtext" id="loadingSubtext">Por favor espera</div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        let map;
        let markers;
        let selectedTerminal = null;
        let selectedBus = null;
        let selectedLugares = [];
        let terminalesData = [];
        let busesData = [];
        let authToken = localStorage.getItem('authToken') || null;
        let lugaresInterval = null;
        let reservaTimeout = null;
        let userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        let userRole = localStorage.getItem('userRole') || 'USER';
        let loginType = 'user'; // 'user' o 'company'
        
        // Inicializar al cargar la p谩gina
        window.onload = function() {
            // Verificar si hay token, si no, mostrar login
            if (authToken) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userInfo').textContent = userInfo.username || 'Usuario';
                initMap();
            } else {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('appContainer').style.display = 'none';
                selectLoginType('user'); // Seleccionar usuario por defecto
            }
        };
        
        // Funci贸n para seleccionar tipo de login
        function selectLoginType(type) {
            loginType = type;
            const userBtn = document.getElementById('userTypeBtn');
            const companyBtn = document.getElementById('companyTypeBtn');
            
            if (type === 'user') {
                userBtn.className = 'btn btn-primary';
                companyBtn.className = 'btn btn-outline-warning';
            } else {
                userBtn.className = 'btn btn-outline-primary';
                companyBtn.className = 'btn btn-warning';
            }
        }
        
        // Funci贸n para mostrar registro
        function mostrarRegistro() {
            if (loginType === 'company') {
                document.getElementById('registroEmpresaModal').style.display = 'block';
            } else {
                document.getElementById('registroUsuarioModal').style.display = 'block';
            }
        }
        
        function closeRegistroUsuarioModal() {
            document.getElementById('registroUsuarioModal').style.display = 'none';
            document.getElementById('registroUsuarioError').style.display = 'none';
        }
        
        async function registrarUsuario() {
            const username = document.getElementById('usuarioUsername').value.trim();
            const password = document.getElementById('usuarioPassword').value.trim();
            const email = document.getElementById('usuarioEmail').value.trim();
            const nombre = document.getElementById('usuarioNombre').value.trim();
            const apellido = document.getElementById('usuarioApellido').value.trim();
            const errorDiv = document.getElementById('registroUsuarioError');
            
            if (!username || !password || !email || !nombre || !apellido) {
                errorDiv.textContent = 'Todos los campos son obligatorios';
                errorDiv.style.display = 'block';
                return;
            }
            
            showLoadingScreen(true, 'Registrando usuario...', 'Creando cuenta de usuario');
            
            try {
                const response = await fetch('http://localhost:8080/api/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        email: email,
                        firstName: nombre,
                        lastName: apellido,
                        phone: '00000000',
                        address: 'Direcci贸n de usuario',
                        birthDate: '1990-01-01',
                        gender: 'M',
                        location: 'Nicaragua',
                        countryOfOrigin: 'Nicaragua',
                        language: 'Espa帽ol',
                        touristInterest: 'Turismo general',
                        social: 'Usuario',
                        description: 'Cuenta de usuario'
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                
                showNotification('Usuario registrado exitosamente. Ya puedes iniciar sesi贸n.', 'success');
                closeRegistroUsuarioModal();
                
            } catch (error) {
                console.error('Error al registrar usuario:', error);
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                showLoadingScreen(false);
            }
        }
        
        // Funci贸n para mostrar/ocultar pantalla de carga
        function showLoadingScreen(show, text = 'Cargando...', subtext = 'Por favor espera') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            if (show) {
                loadingText.textContent = text;
                loadingSubtext.textContent = subtext;
                loadingOverlay.style.display = 'flex';
            } else {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // Funci贸n para iniciar sesi贸n
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            
            if (!username || !password) {
                loginError.textContent = 'Por favor, completa todos los campos';
                loginError.style.display = 'block';
                return;
            }
            
            // Mostrar pantalla de carga
            showLoadingScreen(true, 'Iniciando sesi贸n...', 'Verificando credenciales');
            
            // Determinar endpoint seg煤n tipo de login
            const endpoint = loginType === 'company' ? 
                'http://localhost:8080/api/auth/signin-company' : 
                'http://localhost:8080/api/auth/signin';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // Si no se puede parsear como JSON, usar el mensaje por defecto
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                authToken = data.token;
                
                // Extraer rol del token JWT
                try {
                    const tokenParts = data.token.split('.');
                    const payload = JSON.parse(atob(tokenParts[1]));
                    userRole = payload.role || 'USER';
                    localStorage.setItem('userRole', userRole);
                    console.log('Rol extra铆do del token:', userRole);
                    console.log('Payload completo del token:', payload);
                } catch (e) {
                    console.error('Error al extraer rol del token:', e);
                    userRole = 'USER';
                    localStorage.setItem('userRole', userRole);
                }
                
                // Obtener informaci贸n del usuario incluyendo el email
                try {
                    const userResponse = await fetch('http://localhost:8080/api/user/me', {
                        headers: {
                            'Authorization': `Bearer ${data.token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('Respuesta del endpoint /api/user/me:', userResponse.status);
                    
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        console.log('Datos del usuario obtenidos:', userData);
                        userInfo = {
                            username: username,
                            email: userData.email || username + '@example.com',
                            role: userRole
                        };
                    } else {
                        const errorText = await userResponse.text();
                        console.error('Error al obtener datos del usuario:', errorText);
                        userInfo = {
                            username: username,
                            email: username + '@example.com',
                            role: userRole
                        };
                    }
                } catch (userError) {
                    console.error('Error de red al obtener informaci贸n del usuario:', userError);
                    userInfo = {
                        username: username,
                        email: username + '@example.com',
                        role: userRole
                    };
                }
                
                // Guardar token y userInfo en localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('userInfo', JSON.stringify(userInfo));
                
                // Mostrar notificaci贸n
                showNotification('Sesi贸n iniciada correctamente', 'success');
                
                // Ocultar login y mostrar aplicaci贸n
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userInfo').textContent = username;
                
                // Inicializar la aplicaci贸n
                initMap();
                
            } catch (error) {
                console.error('Error al iniciar sesi贸n:', error);
                console.error('Endpoint usado:', endpoint);
                console.error('Tipo de login:', loginType);
                loginError.textContent = `Error al iniciar sesi贸n: ${error.message}`;
                loginError.style.display = 'block';
            } finally {
                showLoadingScreen(false);
            }
        }
        
        // Funci贸n para cerrar sesi贸n
        function logout() {
            authToken = null;
            userInfo = {};
            userRole = 'USER';
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            localStorage.removeItem('userRole');
            
            showNotification('Sesi贸n cerrada correctamente', 'info');
            
            // Mostrar login y ocultar aplicaci贸n
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
            
            // Limpiar campos de login
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
        }
        
        // Funci贸n para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Inicializar el mapa
        function initMap() {
            // Si el mapa ya existe, no reinicializarlo
            if (map) {
                return;
            }
            
            map = L.map('map').setView([12.1350, -86.2650], 8); // Nicaragua
            
            // Agregar capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Grupo para todos los marcadores
            markers = L.layerGroup().addTo(map);
            
            // Cargar datos
            cargarDatos();
        }
        
        // Funci贸n para cargar todos los datos
        async function cargarDatos() {
            const endpointStatus = document.getElementById('endpointStatus');
            const errorMessage = document.getElementById('errorMessage');
            const loadingMessage = document.getElementById('loadingMessage');
            
            // Mostrar pantalla de carga
            showLoadingScreen(true, 'Cargando terminales...', 'Obteniendo ubicaciones del mapa');
            
            endpointStatus.innerHTML = '';
            errorMessage.style.display = 'none';
            
            try {
                // Cargar terminales
                const terminalesResponse = await verificarEndpoint('http://localhost:8080/api/terminales-buses', 'Terminales');
                
                if (terminalesResponse.success) {
                    terminalesData = terminalesResponse.data;
                    procesarTerminales();
                }
                
                // Ocultar mensaje de carga
                loadingMessage.style.display = 'none';
                
                // Ajustar el mapa para mostrar todos los marcadores
                if (markers.getLayers().length > 0) {
                    // Crear un grupo de capas para obtener los l铆mites
                    const group = new L.featureGroup(markers.getLayers());
                    map.fitBounds(group.getBounds().pad(0.1));
                } else {
                    errorMessage.textContent = 'No se encontraron terminales para mostrar en el mapa';
                    errorMessage.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
                loadingMessage.style.display = 'none';
                errorMessage.innerHTML = `
                    <p>Error al cargar datos: ${error.message}</p>
                    <button class="retry-button" onclick="location.reload()">Reintentar</button>
                `;
                errorMessage.style.display = 'block';
            } finally {
                showLoadingScreen(false);
            }
        }
        
        // Funci贸n para verificar y procesar un endpoint
        async function verificarEndpoint(url, nombre) {
            const endpointStatus = document.getElementById('endpointStatus');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const headers = {
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache'
                };
                
                // Si hay token, agregarlo al header
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: headers
                });
                
                clearTimeout(timeoutId);
                
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('text/html')) {
                    const text = await response.text();
                    throw new Error('El servidor devolvi贸 una p谩gina de error');
                }
                
                if (!response.ok) {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage += ` - ${errorData.message}`;
                        }
                    } catch (parseError) {
                        // No se pudo parsear el error
                    }
                    
                    throw new Error(errorMessage);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    try {
                        const text = await response.text();
                        throw new Error(`Error al parsear JSON: ${jsonError.message}. Respuesta: ${text.substring(0, 200)}...`);
                    } catch (textError) {
                        throw new Error(`Error al procesar la respuesta: ${jsonError.message}`);
                    }
                }
                
                if (!Array.isArray(data)) {
                    throw new Error(`La respuesta no es un array v谩lido: ${typeof data}`);
                }
                
                endpointStatus.innerHTML += `
                    <div class="endpoint-status endpoint-success">
                        <i class="fas fa-check-circle"></i> 
                        ${nombre} cargados correctamente (${data.length} elementos)
                    </div>
                `;
                
                return { success: true, data };
                
            } catch (error) {
                let errorMsg = error.message;
                
                if (error.name === 'AbortError') {
                    errorMsg = 'Timeout: El servidor tard贸 demasiado tiempo en responder';
                }
                
                // Si el error es 401, redirigir a login
                if (error.message.includes('401')) {
                    logout();
                    return { success: false, error: 'Sesi贸n expirada. Por favor, inicia sesi贸n nuevamente.' };
                }
                
                endpointStatus.innerHTML += `
                    <div class="endpoint-status endpoint-error">
                        <i class="fas fa-times-circle"></i> 
                        Error al cargar ${nombre}: ${errorMsg}
                    </div>
                `;
                
                return { success: false, error: errorMsg };
            }
        }
        
        // Funci贸n para procesar terminales
        function procesarTerminales() {
            if (!terminalesData || terminalesData.length === 0) return;
            
            terminalesData.forEach((terminal, index) => {
                if (terminal.ubicacionGeografica && terminal.ubicacionGeografica.latitud && terminal.ubicacionGeografica.longitud) {
                    const busIcon = L.divIcon({
                        html: '<i class="fas fa-bus" style="color: #e74c3c; font-size: 24px;"></i>',
                        iconSize: [24, 24],
                        className: 'custom-div-icon'
                    });
                    
                    const marker = L.marker(
                        [terminal.ubicacionGeografica.latitud, terminal.ubicacionGeografica.longitud], 
                        { icon: busIcon }
                    )
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h3>${terminal.nombre}</h3>
                            <p><strong>Localidad:</strong> ${terminal.localidad}</p>
                            <p><strong>C贸digo:</strong> ${terminal.codigoUnico}</p>
                            <button class="btn btn-primary btn-sm" onclick="showTerminalDetails(${index})">Ver detalles</button>
                        </div>
                    `);
                    
                    markers.addLayer(marker);
                }
            });
        }
        
        // Funci贸n para mostrar detalles de la terminal
        function showTerminalDetails(index) {
            const terminal = terminalesData[index];
            selectedTerminal = terminal;
            
            // Actualizar modal con todos los detalles
            document.getElementById('terminalName').textContent = terminal.nombre;
            document.getElementById('terminalLocation').textContent = terminal.localidad;
            document.getElementById('terminalCodigo').textContent = terminal.codigoUnico;
            document.getElementById('terminalLatitud').textContent = terminal.ubicacionGeografica.latitud;
            document.getElementById('terminalLongitud').textContent = terminal.ubicacionGeografica.longitud;
            document.getElementById('terminalDireccion').textContent = terminal.ubicacionGeografica.direccion || 'No especificada';
            
            // Generar imagen SVG para la terminal
            document.getElementById('terminalImage').src = createTerminalImage(terminal.nombre, terminal.localidad);
            
            // Mostrar modal
            document.getElementById('terminalModal').style.display = 'block';
            
            // Ocultar secciones que se muestran despu茅s de acciones
            document.getElementById('lugaresContainer').style.display = 'none';
            
            // Mostrar la secci贸n de buses con un indicador de carga
            const busDetails = document.getElementById('busDetails');
            busDetails.style.display = 'block';
            document.getElementById('busesList').innerHTML = '<div class="bus-loading"><i class="fas fa-spinner fa-spin"></i> Cargando buses...</div>';
            
            // Cargar buses de esta terminal usando el c贸digo 煤nico
            cargarBusesPorTerminal(terminal.codigoUnico);
        }
        
        // Funci贸n para cargar buses por terminal usando el c贸digo 煤nico
        async function cargarBusesPorTerminal(codigoUnico) {
            // Mostrar pantalla de carga
            showLoadingScreen(true, 'Cargando buses...', 'Obteniendo horarios y destinos');
            
            try {
                // Primero intentar con el endpoint de c贸digo 煤nico
                let response = await fetch(`http://localhost:8080/api/buses/terminal/codigo/${codigoUnico}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                // Si el endpoint de c贸digo 煤nico falla, intentar con el ID
                if (!response.ok) {
                    console.log('Endpoint de c贸digo 煤nico fall贸, intentando con ID');
                    
                    // Buscar la terminal por c贸digo 煤nico en los datos cargados
                    const terminal = terminalesData.find(t => t.codigoUnico === codigoUnico);
                    if (terminal && terminal.id) {
                        response = await fetch(`http://localhost:8080/api/buses/terminal/${terminal.id}`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                let buses;
                try {
                    buses = await response.json();
                } catch (jsonError) {
                    throw new Error(`Error al procesar la respuesta: ${jsonError.message}`);
                }
                
                busesData = buses;
                
                const busesList = document.getElementById('busesList');
                busesList.innerHTML = '';
                
                if (busesData.length === 0) {
                    busesList.innerHTML = '<p>No hay buses disponibles en esta terminal</p>';
                    return;
                }
                
                // Crear tarjetas para cada bus
                busesData.forEach((bus, index) => {
                    const busCard = document.createElement('div');
                    busCard.className = 'card mb-3';
                    busCard.innerHTML = `
                        <div class="card-body">
                            <div class="bus-info">
                                <div class="bus-info-item">
                                    <div class="bus-info-label">N煤mero de Bus</div>
                                    <div class="bus-info-value">${bus.numeroBus}</div>
                                </div>
                                <div class="bus-info-item">
                                    <div class="bus-info-label">Destino</div>
                                    <div class="bus-info-value">${bus.destino}</div>
                                </div>
                                <div class="bus-info-item">
                                    <div class="bus-info-label">Hora Salida</div>
                                    <div class="bus-info-value">${bus.horaSalida}</div>
                                </div>
                                <div class="bus-info-item">
                                    <div class="bus-info-label">Total de Lugares</div>
                                    <div class="bus-info-value">${bus.totalLugares}</div>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="seleccionarBus(${index})">Seleccionar Bus</button>
                        </div>
                    `;
                    busesList.appendChild(busCard);
                });
                
            } catch (error) {
                console.error('Error al cargar buses:', error);
                document.getElementById('busesList').innerHTML = `
                    <div class="error">
                        <p>Error al cargar los buses: ${error.message}</p>
                        <p>Verifica que la terminal exista y tenga buses asociados.</p>
                        <button class="retry-button" onclick="cargarBusesPorTerminal('${codigoUnico}')">Reintentar</button>
                    </div>
                `;
            } finally {
                showLoadingScreen(false);
            }
        }
        
        // Funci贸n para crear imagen SVG din谩mica
        function createTerminalImage(nombre, localidad) {
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="400" height="300" fill="url(#grad1)"/>
                    <rect x="50" y="50" width="300" height="200" fill="white" opacity="0.9" rx="10"/>
                    <text x="200" y="120" font-family="Arial" font-size="24" font-weight="bold" text-anchor="middle" fill="#2c3e50">${nombre}</text>
                    <text x="200" y="150" font-family="Arial" font-size="16" text-anchor="middle" fill="#7f8c8d">Terminal de Buses</text>
                    <text x="200" y="180" font-family="Arial" font-size="14" text-anchor="middle" fill="#7f8c8d">${localidad}</text>
                    <circle cx="100" cy="220" r="8" fill="#e74c3c"/>
                    <circle cx="200" cy="220" r="8" fill="#e74c3c"/>
                    <circle cx="300" cy="220" r="8" fill="#e74c3c"/>
                </svg>
            `;
            
            return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
        }
        
        // Seleccionar un bus espec铆fico
        function seleccionarBus(index) {
            selectedBus = busesData[index];
            selectedLugares = []; // Resetear selecci贸n de lugares
            document.getElementById('confirmarReservaBtn').disabled = true;
            document.getElementById('resumenSeleccion').style.display = 'none';
            
            // Mostrar lugares y cargar desde el backend
            mostrarLugares();
        }
        
        // Mostrar lugares disponibles en cuadr铆cula
        function mostrarLugares() {
            if (!selectedBus) {
                showNotification('Debe seleccionar un bus primero', 'error');
                return;
            }
            
            // Mostrar contenedor de lugares
            document.getElementById('lugaresContainer').style.display = 'block';
            
            // Actualizar contador de lugares disponibles
            document.getElementById('lugaresDisponiblesValor').textContent = selectedBus.lugaresDisponibles;
            
            // Mostrar indicador de carga
            const lugaresGrid = document.getElementById('lugaresGrid');
            lugaresGrid.innerHTML = '<div class="bus-loading"><i class="fas fa-spinner fa-spin"></i> Cargando lugares...</div>';
            
            // Configurar actualizaci贸n peri贸dica
            if (lugaresInterval) {
                clearInterval(lugaresInterval);
            }
            
            lugaresInterval = setInterval(() => {
                cargarLugaresBus();
            }, 10000);
            
            // Cargar lugares inmediatamente
            cargarLugaresBus();
        }
        
        // Funci贸n para cargar los lugares de un bus
        async function cargarLugaresBus() {
            const lugaresGrid = document.getElementById('lugaresGrid');
            
            // Mostrar pantalla de carga solo en la primera carga, no en actualizaciones
            const isFirstLoad = lugaresGrid.innerHTML.includes('Cargando lugares...');
            if (isFirstLoad) {
                showLoadingScreen(true, 'Cargando asientos...', 'Verificando disponibilidad');
            }
            
            try {
                // Verificar que selectedBus existe y tiene un ID
                if (!selectedBus || !selectedBus.id) {
                    throw new Error('No se ha seleccionado un bus v谩lido');
                }
                
                const response = await fetch(`http://localhost:8080/api/reservas-bus/buses/${selectedBus.id}/lugares`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    try {
                        const errorText = await response.text();
                        if (errorText) {
                            errorMessage += ` - ${errorText}`;
                        }
                    } catch (e) {
                        // Ignore parsing errors
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('Datos recibidos del backend:', data);
                
                const totalLugares = data.totalLugares;
                const lugares = data.lugares;
                const lugaresDisponibles = lugares.filter(lugar => lugar.disponible === true).length;
                
                lugaresGrid.innerHTML = '';
                
                // Crear layout de bus con filas horizontales
                const busLayout = document.createElement('div');
                busLayout.className = 'bus-layout';
                
                let seatNumber = 1;
                const totalRows = Math.ceil(totalLugares / 2);
                
                for (let row = 0; row < totalRows; row++) {
                    const rowContainer = document.createElement('div');
                    rowContainer.className = 'bus-row';
                    
                    // Crear hasta 2 asientos por fila
                    for (let col = 0; col < 2 && seatNumber <= totalLugares; col++) {
                        const currentSeatNumber = seatNumber;
                        const lugarItem = document.createElement('div');
                        
                        // Buscar el lugar en la respuesta del backend
                        const lugarInfo = lugares.find(lugar => lugar.numero === currentSeatNumber);
                        const disponible = lugarInfo ? lugarInfo.disponible : true;
                        
                        console.log(`Asiento ${currentSeatNumber}: lugarInfo =`, lugarInfo, 'disponible =', disponible);
                        
                        lugarItem.className = 'lugar-item';
                        if (disponible) {
                            lugarItem.classList.add('disponible');
                        } else {
                            lugarItem.classList.add('reservado');
                        }
                        
                        lugarItem.textContent = currentSeatNumber;
                        lugarItem.dataset.lugar = JSON.stringify({ numero: currentSeatNumber, disponible });
                        
                        if (disponible) {
                            lugarItem.addEventListener('click', () => {
                                const lugarData = { numero: currentSeatNumber, disponible: true };
                                
                                if (lugarItem.classList.contains('selected')) {
                                    lugarItem.classList.remove('selected');
                                    selectedLugares = selectedLugares.filter(l => l.numero !== lugarData.numero);
                                } else {
                                    lugarItem.classList.add('selected');
                                    selectedLugares.push(lugarData);
                                }
                                
                                document.getElementById('confirmarReservaBtn').disabled = selectedLugares.length === 0;
                                actualizarResumenSeleccion();
                            });
                        }
                        
                        rowContainer.appendChild(lugarItem);
                        seatNumber++;
                    }
                    
                    // Agregar pasillo despu茅s de cada fila (excepto la 煤ltima)
                    if (row < totalRows - 1) {
                        const aisle = document.createElement('div');
                        aisle.className = 'bus-aisle-horizontal';
                        aisle.textContent = 'PASILLO';
                        rowContainer.appendChild(aisle);
                    }
                    
                    busLayout.appendChild(rowContainer);
                }
                
                lugaresGrid.appendChild(busLayout);
                
                // Actualizar contador de lugares disponibles
                document.getElementById('lugaresDisponiblesValor').textContent = lugaresDisponibles;
                
            } catch (error) {
                console.error('Error al cargar lugares:', error);
                console.error('Bus seleccionado:', selectedBus);
                
                // Fallback: usar totalLugares del bus para mostrar asientos
                if (selectedBus && selectedBus.totalLugares) {
                    console.log('Usando fallback con totalLugares del bus:', selectedBus.totalLugares);
                    
                    lugaresGrid.innerHTML = '';
                    const busLayout = document.createElement('div');
                    busLayout.className = 'bus-layout';
                    
                    const totalLugares = selectedBus.totalLugares;
                    let seatNumber = 1;
                    const totalRows = Math.ceil(totalLugares / 2);
                    
                    for (let row = 0; row < totalRows; row++) {
                        const rowContainer = document.createElement('div');
                        rowContainer.className = 'bus-row';
                        
                        for (let col = 0; col < 2 && seatNumber <= totalLugares; col++) {
                            const currentSeatNumber = seatNumber;
                            const lugarItem = document.createElement('div');
                            lugarItem.className = 'lugar-item disponible';
                            lugarItem.textContent = currentSeatNumber;
                            
                            lugarItem.addEventListener('click', () => {
                                const lugarData = { numero: currentSeatNumber, disponible: true };
                                
                                if (lugarItem.classList.contains('selected')) {
                                    lugarItem.classList.remove('selected');
                                    selectedLugares = selectedLugares.filter(l => l.numero !== lugarData.numero);
                                } else {
                                    lugarItem.classList.add('selected');
                                    selectedLugares.push(lugarData);
                                }
                                
                                document.getElementById('confirmarReservaBtn').disabled = selectedLugares.length === 0;
                                actualizarResumenSeleccion();
                            });
                            
                            rowContainer.appendChild(lugarItem);
                            seatNumber++;
                        }
                        
                        if (row < totalRows - 1) {
                            const aisle = document.createElement('div');
                            aisle.className = 'bus-aisle-horizontal';
                            aisle.textContent = 'PASILLO';
                            rowContainer.appendChild(aisle);
                        }
                        
                        busLayout.appendChild(rowContainer);
                    }
                    
                    lugaresGrid.appendChild(busLayout);
                    document.getElementById('lugaresDisponiblesValor').textContent = totalLugares;
                    
                } else {
                    lugaresGrid.innerHTML = `
                        <div class="error">
                            <p>Error al cargar los lugares: ${error.message}</p>
                            <p>Bus ID: ${selectedBus?.id || 'No disponible'}</p>
                            <button class="retry-button" onclick="cargarLugaresBus()">Reintentar</button>
                        </div>
                    `;
                }
            } finally {
                if (isFirstLoad) {
                    showLoadingScreen(false);
                }
            }
        }
        
        // Funci贸n para actualizar el resumen de selecci贸n
        function actualizarResumenSeleccion() {
            const resumenSeleccion = document.getElementById('resumenSeleccion');
            
            if (selectedBus && selectedLugares.length > 0) {
                // Mostrar el resumen
                resumenSeleccion.style.display = 'block';
                
                // Actualizar los valores
                document.getElementById('resumenBus').textContent = selectedBus.numeroBus;
                document.getElementById('resumenDestino').textContent = selectedBus.destino;
                document.getElementById('resumenHora').textContent = selectedBus.horaSalida;
                
                const lugaresTexto = selectedLugares.map(l => l.numero).sort((a, b) => a - b).join(', ');
                document.getElementById('resumenLugar').textContent = `Lugares: ${lugaresTexto}`;
            } else {
                // Ocultar el resumen
                resumenSeleccion.style.display = 'none';
            }
        }
        
        // Mostrar modal de email
        function confirmarReserva() {
            if (!selectedTerminal || !selectedBus || selectedLugares.length === 0) {
                showNotification('Por favor, selecciona un terminal, un bus y al menos un lugar', 'error');
                return;
            }
            
            document.getElementById('emailModal').style.display = 'block';
            document.getElementById('emailInput').value = userInfo.email || '';
        }
        
        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }
        
        // Procesar reserva con email
        async function procesarReservaConEmail(retryCount = 0) {
            const email = document.getElementById('emailInput').value.trim();
            
            if (!email) {
                showNotification('Por favor, ingresa un email v谩lido', 'error');
                return;
            }
            
            closeEmailModal();
            
            if (window.reservaInProgress && retryCount === 0) {
                showNotification('Ya hay una reserva en proceso. Por favor espera.', 'info');
                return;
            }
            window.reservaInProgress = true;
            
            const lugaresInvalidos = selectedLugares.filter(lugar => lugar.numero > selectedBus.totalLugares);
            if (lugaresInvalidos.length > 0) {
                showNotification(`Lugares inv谩lidos seleccionados: ${lugaresInvalidos.map(l => l.numero).join(', ')}`, 'error');
                selectedLugares = selectedLugares.filter(lugar => lugar.numero <= selectedBus.totalLugares);
                actualizarResumenSeleccion();
                return;
            }
            
            // Mostrar pantalla de carga
            showLoadingScreen(true, 'Procesando reserva...', 'Confirmando asientos y enviando email');
            
            // Generar un identificador 煤nico del cliente para evitar duplicados
            const clientId = Date.now() + '-' + Math.random().toString(36).substr(2, 9) + '-' + retryCount;
            
            // Crear una sola reserva con m煤ltiples lugares
            const reservaRequest = {
                terminalId: selectedTerminal.id,
                busId: selectedBus.id,
                numerosLugar: selectedLugares.map(l => l.numero),
                nombreUsuario: userInfo.username,
                emailUsuario: email,
                clientRequestId: clientId // Identificador 煤nico del cliente
            };
            
            // Validar que todos los campos requeridos est茅n presentes
            if (!reservaRequest.terminalId || !reservaRequest.busId || 
                !reservaRequest.numerosLugar || reservaRequest.numerosLugar.length === 0 || 
                !reservaRequest.nombreUsuario || !reservaRequest.emailUsuario) {
                console.error('Datos faltantes en reserva:', reservaRequest);
                showNotification('Datos faltantes en la reserva', 'error');
                return;
            }
            
            console.log('Token:', authToken);
            console.log('Bus seleccionado:', selectedBus);
            console.log('Terminal seleccionada:', selectedTerminal);
            
            // Verificar que el token existe
            if (!authToken) {
                showNotification('No hay token de autenticaci贸n. Inicia sesi贸n nuevamente.', 'error');
                logout();
                return;
            }
            
            try {
                console.log('Enviando reserva:', reservaRequest);
                console.log('Validando campos:', {
                    terminalId: typeof reservaRequest.terminalId,
                    busId: typeof reservaRequest.busId,
                    numerosLugar: typeof reservaRequest.numerosLugar,
                    nombreUsuario: typeof reservaRequest.nombreUsuario,
                    emailUsuario: typeof reservaRequest.emailUsuario
                });
                
                const response = await fetch('http://localhost:8080/api/reservas-bus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(reservaRequest)
                });
                
                if (!response.ok) {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    
                    if (response.status === 401 || response.status === 403) {
                        showNotification('Sesi贸n expirada. Inicia sesi贸n nuevamente.', 'error');
                        logout();
                        return;
                    }
                    
                    try {
                        const errorText = await response.text();
                        console.log('Error del servidor (texto):', errorText);
                        
                        // Intentar parsear como JSON primero
                        try {
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.message || errorText;
                        } catch (jsonError) {
                            // Si no es JSON, usar el texto directamente
                            errorMessage = errorText || errorMessage;
                        }
                    } catch (textError) {
                        console.error('No se pudo obtener el error del servidor:', textError);
                        errorMessage = `Error ${response.status}: No se pudo leer la respuesta del servidor`;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                const codigosReserva = data.map(reserva => `Lugar ${reserva.numeroLugar}: ${reserva.codigoUnico}`);
                
                // Actualizar los lugares inmediatamente
                cargarLugaresBus();
                
                // Mostrar modal de confirmaci贸n con todos los c贸digos
                document.getElementById('codigoReserva').innerHTML = codigosReserva.join('<br>');
                document.getElementById('confirmacionModal').style.display = 'block';
                
                // Mostrar notificaci贸n
                showNotification(`${selectedLugares.length} reserva(s) realizada(s) con 茅xito`, 'success');
                
                // Limpiar selecci贸n
                selectedLugares = [];
                
                // Cerrar modal de terminal despu茅s de un tiempo
                setTimeout(() => {
                    closeTerminalModal();
                }, 3000);
                
            } catch (error) {
                console.error('Error al realizar reserva:', error);
                
                // Verificar si es error de c贸digo duplicado o generaci贸n
                const isDuplicateError = error.message.includes('duplicate key') || 
                                       error.message.includes('UNIQUE KEY constraint') ||
                                       error.message.includes('UK_h5nkyra9etltqlkhh72769drt') ||
                                       error.message.includes('Error de integridad de datos') ||
                                       error.message.includes('No se pudo generar') ||
                                       error.message.includes('c贸digo 煤nico');
                
                if (isDuplicateError && retryCount < 8) {
                    showLoadingScreen(false);
                    showNotification(`Conflicto detectado. Reintentando... (${retryCount + 1}/8)`, 'info');
                    
                    // Delay aleatorio m谩s largo para evitar colisiones
                    const delay = Math.random() * 3000 + 2000 + (retryCount * 500);
                    setTimeout(() => {
                        procesarReservaConEmail(retryCount + 1);
                    }, delay);
                    return;
                } else if (isDuplicateError) {
                    showNotification('Sistema ocupado. Int茅ntalo en unos minutos.', 'error');
                    window.reservaInProgress = false;
                    return;
                }
                
                showNotification('Error al realizar la reserva: ' + error.message, 'error');
            } finally {
                showLoadingScreen(false);
                window.reservaInProgress = false;
            }
        }
        

        
        // Funciones para cerrar modales
        function closeTerminalModal() {
            document.getElementById('terminalModal').style.display = 'none';
            document.getElementById('lugaresContainer').style.display = 'none';
            document.getElementById('busDetails').style.display = 'none';
            selectedTerminal = null;
            selectedBus = null;
            selectedLugares = [];
            document.getElementById('confirmarReservaBtn').disabled = true;
            
            // Limpiar intervalo de actualizaci贸n de lugares
            if (lugaresInterval) {
                clearInterval(lugaresInterval);
                lugaresInterval = null;
            }
        }
        
        function closeLugares() {
            document.getElementById('lugaresContainer').style.display = 'none';
            selectedLugares = [];
            document.getElementById('confirmarReservaBtn').disabled = true;
            document.getElementById('resumenSeleccion').style.display = 'none';
        }
        
        function closeConfirmacionModal() {
            document.getElementById('confirmacionModal').style.display = 'none';
        }
        
        // Funciones para validar c贸digo
        function mostrarValidarCodigo() {
            document.getElementById('validarCodigoModal').style.display = 'block';
            document.getElementById('codigoValidar').value = '';
            document.getElementById('resultadoValidacion').style.display = 'none';
            selectValidationMethod('codigo');
        }
        
        function selectValidationMethod(method) {
            // Actualizar botones
            document.getElementById('btnCodigo').className = method === 'codigo' ? 'btn btn-primary method-btn active' : 'btn btn-secondary method-btn';
            document.getElementById('btnQR').className = method === 'qr' ? 'btn btn-primary method-btn active' : 'btn btn-secondary method-btn';
            
            // Mostrar/ocultar secciones
            document.getElementById('validacionCodigo').style.display = method === 'codigo' ? 'block' : 'none';
            document.getElementById('validacionQR').style.display = method === 'qr' ? 'block' : 'none';
            
            // Limpiar resultados
            document.getElementById('resultadoValidacion').style.display = 'none';
        }
        
        function previewQR(input) {
            const file = input.files[0];
            const preview = document.getElementById('qrPreview');
            const image = document.getElementById('qrImage');
            const btn = document.getElementById('validarQRBtn');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    image.src = e.target.result;
                    preview.style.display = 'block';
                    btn.disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                btn.disabled = true;
            }
        }
        
        async function validarQR() {
            const fileInput = document.getElementById('qrFile');
            const resultado = document.getElementById('resultadoValidacion');
            
            if (!fileInput.files[0]) {
                showNotification('Selecciona una imagen QR', 'error');
                return;
            }
            
            // Mostrar pantalla de carga
            showLoadingScreen(true, 'Procesando QR...', 'Decodificando imagen y validando');
            
            // Leer el archivo QR y extraer el c贸digo
            const file = fileInput.files[0];
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = async function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                try {
                    // Usar una librer铆a de QR para decodificar (simulado)
                    // En un caso real, usar铆as una librer铆a como jsQR
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Simular extracci贸n del c贸digo QR
                    // En la pr谩ctica, usar铆as jsQR.decode(imageData)
                    showLoadingScreen(false);
                    const codigoExtraido = prompt('Ingresa el c贸digo que aparece en el QR:');
                    
                    if (!codigoExtraido) {
                        showNotification('C贸digo QR requerido', 'error');
                        return;
                    }
                    
                    showLoadingScreen(true, 'Validando c贸digo...', 'Verificando en el servidor');
                    
                    // Validar el c贸digo extra铆do
                    const response = await fetch(`http://localhost:8080/api/reservas-bus/validar/${codigoExtraido}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const mensaje = await response.text();
                        resultado.className = 'endpoint-success';
                        resultado.innerHTML = `<i class="fas fa-check-circle"></i> ${mensaje}`;
                        showNotification('QR validado correctamente', 'success');
                    } else {
                        const error = await response.text();
                        resultado.className = 'endpoint-error';
                        resultado.innerHTML = `<i class="fas fa-times-circle"></i> ${error}`;
                        showNotification('QR inv谩lido', 'error');
                    }
                    
                    resultado.style.display = 'block';
                    
                } catch (error) {
                    console.error('Error al validar QR:', error);
                    resultado.className = 'endpoint-error';
                    resultado.innerHTML = `<i class="fas fa-times-circle"></i> Error de conexi贸n: ${error.message}`;
                    resultado.style.display = 'block';
                    showNotification('Error al validar QR', 'error');
                } finally {
                    showLoadingScreen(false);
                }
            };
            
            img.src = URL.createObjectURL(file);
        }
        
        function closeValidarCodigoModal() {
            document.getElementById('validarCodigoModal').style.display = 'none';
        }
        
        // Funciones para conductor
        function mostrarConductorModal() {
            console.log('Rol actual del usuario:', userRole);
            if (userRole !== 'COMPANY') {
                showNotification('Solo las cuentas empresariales pueden liberar buses', 'error');
                return;
            }
            document.getElementById('conductorModal').style.display = 'block';
            cargarBusesParaConductor();
        }
        
        function closeRegistroEmpresaModal() {
            document.getElementById('registroEmpresaModal').style.display = 'none';
            document.getElementById('registroEmpresaError').style.display = 'none';
        }
        
        function generarUsuarioEmpresa() {
            const randomNum = Math.floor(Math.random() * 10000);
            document.getElementById('empresaUsername').value = `empresa${randomNum}`;
        }
        
        function generarUsuarioRegular() {
            const randomNum = Math.floor(Math.random() * 10000);
            document.getElementById('usuarioUsername').value = `usuario${randomNum}`;
        }
        
        async function registrarEmpresa() {
            const username = document.getElementById('empresaUsername').value.trim();
            const password = document.getElementById('empresaPassword').value.trim();
            const email = document.getElementById('empresaEmail').value.trim();
            const nombre = document.getElementById('empresaNombre').value.trim();
            const errorDiv = document.getElementById('registroEmpresaError');
            
            if (!username || !password || !email || !nombre) {
                errorDiv.textContent = 'Todos los campos son obligatorios';
                errorDiv.style.display = 'block';
                return;
            }
            
            showLoadingScreen(true, 'Registrando empresa...', 'Creando cuenta empresarial');
            
            try {
                const response = await fetch('http://localhost:8080/api/auth/signup-company', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        email: email,
                        firstName: nombre,
                        lastName: 'Empresa',
                        phone: '00000000',
                        address: 'Direcci贸n empresarial',
                        birthDate: '2000-01-01',
                        gender: 'M',
                        location: 'Nicaragua',
                        countryOfOrigin: 'Nicaragua',
                        language: 'Espa帽ol',
                        touristInterest: 'Turismo empresarial',
                        social: 'Empresa',
                        description: 'Cuenta empresarial'
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                
                showNotification('Empresa registrada exitosamente. Inicia sesi贸n con tu nueva cuenta.', 'success');
                closeRegistroEmpresaModal();
                
                // Sugerir cerrar sesi贸n actual para iniciar con cuenta empresarial
                if (confirm('驴Deseas cerrar sesi贸n actual para iniciar con tu cuenta empresarial?')) {
                    logout();
                }
                
            } catch (error) {
                console.error('Error al registrar empresa:', error);
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                showLoadingScreen(false);
            }
        }
        
        function closeConductorModal() {
            document.getElementById('conductorModal').style.display = 'none';
        }
        
        async function cargarBusesParaConductor() {
            const busesList = document.getElementById('conductorBusesList');
            busesList.innerHTML = '<div class="loading">Cargando buses...</div>';
            
            try {
                if (!selectedTerminal) {
                    throw new Error('No hay terminal seleccionada');
                }
                
                const response = await fetch(`http://localhost:8080/api/buses/terminal/codigo/${selectedTerminal.codigoUnico}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const buses = await response.json();
                busesList.innerHTML = '';
                
                if (buses.length === 0) {
                    busesList.innerHTML = '<p>No hay buses en esta terminal</p>';
                    return;
                }
                
                buses.forEach(bus => {
                    const busCard = document.createElement('div');
                    busCard.className = 'card mb-2';
                    busCard.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Bus ${bus.numeroBus}</strong> - ${bus.destino}<br>
                                    <small>Salida: ${bus.horaSalida} | Lugares: ${bus.lugaresDisponibles}/${bus.totalLugares}</small>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="liberarBus(${bus.id}, '${bus.numeroBus}')">
                                    Liberar Bus
                                </button>
                            </div>
                        </div>
                    `;
                    busesList.appendChild(busCard);
                });
                
            } catch (error) {
                console.error('Error al cargar buses:', error);
                busesList.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        async function liberarBus(busId, numeroBus) {
            if (!confirm(`驴Est谩s seguro de que el bus ${numeroBus} ha salido de la terminal? Esto liberar谩 TODOS los asientos reservados.`)) {
                return;
            }
            
            console.log('=== DEBUG LIBERAR BUS ===');
            console.log('Token:', authToken);
            console.log('Rol del usuario:', userRole);
            console.log('Bus ID:', busId);
            
            showLoadingScreen(true, 'Liberando bus...', 'Eliminando todas las reservas');
            
            try {
                const response = await fetch(`http://localhost:8080/api/reservas-bus/conductor/liberar-bus/${busId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Respuesta del servidor:', response.status, response.statusText);
                
                if (response.status === 403) {
                    const errorText = await response.text();
                    console.log('Error 403:', errorText);
                    showNotification('Acceso denegado: ' + errorText, 'error');
                    return;
                }
                
                if (!response.ok) {
                    const error = await response.text();
                    console.log('Error del servidor:', error);
                    throw new Error(error);
                }
                
                const mensaje = await response.text();
                console.log('Respuesta exitosa:', mensaje);
                showNotification(`Bus ${numeroBus} liberado correctamente`, 'success');
                
                // Recargar la lista de buses
                cargarBusesParaConductor();
                
                // Si hay lugares cargados, actualizarlos
                if (selectedBus && selectedBus.id === busId) {
                    cargarLugaresBus();
                }
                
            } catch (error) {
                console.error('Error al liberar bus:', error);
                if (error.message.includes('403') || error.message.includes('Acceso denegado')) {
                    showNotification('Solo las cuentas empresariales pueden liberar buses', 'error');
                } else {
                    showNotification('Error al liberar bus: ' + error.message, 'error');
                }
            } finally {
                showLoadingScreen(false);
            }
        }
        
        async function validarCodigo() {
            const codigo = document.getElementById('codigoValidar').value.trim();
            const resultado = document.getElementById('resultadoValidacion');
            
            if (!codigo) {
                showNotification('Ingresa un c贸digo de reserva', 'error');
                return;
            }
            
            // Mostrar pantalla de carga
            showLoadingScreen(true, 'Validando c贸digo...', 'Verificando reserva en el sistema');
            
            try {
                const response = await fetch(`http://localhost:8080/api/reservas-bus/validar/${codigo}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const mensaje = await response.text();
                    resultado.className = 'endpoint-success';
                    resultado.innerHTML = `<i class="fas fa-check-circle"></i> ${mensaje}`;
                    showNotification('C贸digo validado correctamente', 'success');
                } else {
                    const error = await response.text();
                    resultado.className = 'endpoint-error';
                    resultado.innerHTML = `<i class="fas fa-times-circle"></i> ${error}`;
                    showNotification('C贸digo inv谩lido', 'error');
                }
                
                resultado.style.display = 'block';
                
            } catch (error) {
                console.error('Error al validar c贸digo:', error);
                resultado.className = 'endpoint-error';
                resultado.innerHTML = `<i class="fas fa-times-circle"></i> Error de conexi贸n: ${error.message}`;
                resultado.style.display = 'block';
                showNotification('Error al validar c贸digo', 'error');
            } finally {
                showLoadingScreen(false);
            }
        }
        
        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target == document.getElementById('terminalModal')) {
                closeTerminalModal();
            }
            if (event.target == document.getElementById('confirmacionModal')) {
                closeConfirmacionModal();
            }
            if (event.target == document.getElementById('validarCodigoModal')) {
                closeValidarCodigoModal();
            }
            if (event.target == document.getElementById('emailModal')) {
                closeEmailModal();
            }
            if (event.target == document.getElementById('conductorModal')) {
                closeConductorModal();
            }
            if (event.target == document.getElementById('registroEmpresaModal')) {
                closeRegistroEmpresaModal();
            }
            if (event.target == document.getElementById('registroUsuarioModal')) {
                closeRegistroUsuarioModal();
            }
        }
    </script>
</body>
</html>